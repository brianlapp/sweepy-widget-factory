<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweepstakes Widget</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script>
        // Enhanced diagnostic logging utility
        const logger = {
            timeStart: Date.now(),
            formatTime: () => `[${new Date().toISOString()}]`,
            info: function(msg, ...args) {
                console.log(`${this.formatTime()} [Widget Embed] ${msg}`, ...args);
            },
            error: function(msg, ...args) {
                console.error(`${this.formatTime()} [Widget Embed] Error: ${msg}`, ...args);
                if (window.parent) {
                    window.parent.postMessage({ type: 'WIDGET_ERROR', error: { message: msg, details: args }}, '*');
                }
            },
            warn: function(msg, ...args) {
                console.warn(`${this.formatTime()} [Widget Embed] Warning: ${msg}`, ...args);
            }
        };

        logger.info('Embed page loading...');

        // Initialize widget with retry logic
        let initRetries = 0;
        const MAX_RETRIES = 3;
        const RETRY_DELAY = 1000;
        
        function initializeWidgetWithRetry(data) {
            try {
                if (window.initializeWidget) {
                    logger.info('Initializing widget with data:', data);
                    window.initializeWidget(data.sweepstakesId);
                    logger.info('Widget initialized successfully');
                } else if (initRetries < MAX_RETRIES) {
                    initRetries++;
                    logger.warn(`Retry ${initRetries}/${MAX_RETRIES} - Widget not ready`);
                    setTimeout(() => initializeWidgetWithRetry(data), RETRY_DELAY * initRetries);
                } else {
                    throw new Error('Widget initialization failed after retries');
                }
            } catch (error) {
                logger.error('Initialization error:', error);
            }
        }

        // Message handling
        window.addEventListener('message', function(event) {
            try {
                logger.info('Received message:', event.data);
                
                if (event.data.type === 'INIT_WIDGET') {
                    if (!event.data.sweepstakesId) {
                        throw new Error('No sweepstakes ID provided');
                    }
                    window.WIDGET_CONFIG = event.data;
                    initializeWidgetWithRetry(event.data);
                }
            } catch (error) {
                logger.error('Message handling error:', error);
            }
        });

        logger.info('Embed page ready');
    </script>
</head>
<body>
    <div id="root"></div>
    <script src="widget.js"></script>
</body>
</html>