<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweepstakes Widget</title>
</head>
<body>
    <div id="root"></div>
    <script>
        console.log('[Widget Verification] Starting initialization...');
        
        // Initialize widget state with enhanced error tracking
        window.__WIDGET_STATE__ = {
            loadStartTime: Date.now(),
            reactLoaded: false,
            widgetInitialized: false,
            error: null,
            logs: [],
            lastMessageTime: 0,
            processedMessages: new Set(),
            verificationPoints: {
                initialization: false,
                resourcesLoaded: false,
                reactMounted: false,
                errorHandling: false,
                recoveryAttempted: false,
                healthCheck: false
            },
            errorMetrics: {
                count: 0,
                lastError: null,
                recoveryAttempts: 0,
                successfulRecoveries: 0
            }
        };

        // Enhanced verification logging
        function logVerification(point, status, details = {}) {
            const timestamp = new Date().toISOString();
            const logEntry = {
                point,
                status,
                timestamp,
                details
            };
            
            window.__WIDGET_STATE__.verificationPoints[point] = status;
            window.__WIDGET_STATE__.logs.push(logEntry);
            
            console.log(`[Widget Verification] ${point}:`, status, details);
            
            // Send verification status to parent
            window.parent.postMessage({
                type: 'WIDGET_VERIFICATION',
                verification: logEntry
            }, '*');
        }

        // Enhanced error handling
        function handleError(error, context) {
            const errorMetrics = window.__WIDGET_STATE__.errorMetrics;
            errorMetrics.count++;
            errorMetrics.lastError = {
                message: error.message,
                stack: error.stack,
                context,
                timestamp: new Date().toISOString()
            };

            logVerification('errorHandling', true, {
                error: errorMetrics.lastError,
                totalErrors: errorMetrics.count
            });

            // Attempt recovery if possible
            if (errorMetrics.recoveryAttempts < 3) {
                errorMetrics.recoveryAttempts++;
                logVerification('recoveryAttempted', true, {
                    attempt: errorMetrics.recoveryAttempts
                });
                
                window.parent.postMessage({
                    type: 'WIDGET_RETRY',
                    error: errorMetrics.lastError
                }, '*');
            } else {
                console.error('[Widget Error] Max recovery attempts reached');
            }
        }

        // Resource loading monitoring
        const resourceObserver = new PerformanceObserver((list) => {
            list.getEntries().forEach(entry => {
                logVerification('resourcesLoaded', true, {
                    resource: entry.name,
                    duration: entry.duration,
                    type: entry.entryType
                });
            });
        });

        resourceObserver.observe({ 
            entryTypes: ['resource', 'navigation', 'paint'] 
        });

        // Error event listeners
        window.onerror = function(msg, url, line, col, error) {
            handleError(error || new Error(msg), {
                type: 'window.onerror',
                url,
                line,
                col
            });
            return false;
        };

        window.addEventListener('unhandledrejection', function(event) {
            handleError(event.reason, {
                type: 'unhandledrejection'
            });
        });

        // React mounting verification
        Object.defineProperty(window, 'React', {
            set: function(value) {
                window.__WIDGET_STATE__.reactLoaded = true;
                logVerification('reactMounted', true, {
                    version: value?.version
                });
                return value;
            },
            configurable: true
        });

        // Widget initialization with enhanced error handling
        window.__initializeWidget = function(sweepstakesId) {
            logVerification('initialization', true, { sweepstakesId });
            
            try {
                if (!window.initializeWidget) {
                    throw new Error('Widget initialization function not found');
                }
                
                window.initializeWidget(sweepstakesId);
                window.__WIDGET_STATE__.widgetInitialized = true;
                
                window.parent.postMessage({ 
                    type: 'WIDGET_READY',
                    sweepstakesId 
                }, '*');

                // Start health check interval
                setInterval(() => {
                    const health = {
                        memory: performance.memory ? {
                            usedJSHeapSize: performance.memory.usedJSHeapSize,
                            totalJSHeapSize: performance.memory.totalJSHeapSize
                        } : null,
                        timing: performance.timing,
                        errors: window.__WIDGET_STATE__.errorMetrics
                    };

                    logVerification('healthCheck', true, health);
                }, 30000);

            } catch (error) {
                handleError(error, {
                    type: 'initialization',
                    sweepstakesId
                });
                throw error;
            }
        };

        // Load widget script
        const widgetScript = document.createElement('script');
        widgetScript.src = '/widget.js';
        widgetScript.onload = () => {
            logVerification('resourcesLoaded', true, { script: 'widget.js' });
        };
        widgetScript.onerror = (error) => {
            handleError(error, { type: 'script-load' });
        };

        document.body.appendChild(widgetScript);

        // Periodic state logging
        setInterval(() => {
            console.table(window.__WIDGET_STATE__.verificationPoints);
            console.table(window.__WIDGET_STATE__.errorMetrics);
        }, 5000);
    </script>
</body>
</html>