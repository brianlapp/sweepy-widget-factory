<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweepstakes Widget</title>
</head>
<body>
    <div id="root"></div>
    <script>
        console.log('[Widget] Starting initialization...');
        
        // Enhanced initialization and resource tracking
        window.__WIDGET_STATE__ = {
            loadStartTime: Date.now(),
            reactLoaded: false,
            widgetInitialized: false,
            error: null,
            logs: [],
            lastMessageTime: 0,
            processedMessages: new Set(),
            resources: {
                scripts: new Set(),
                styles: new Set(),
                images: new Set(),
                loadedCount: 0,
                totalCount: 0
            }
        };

        // Message debouncing
        function shouldProcessMessage(type, data) {
            const now = Date.now();
            if (now - window.__WIDGET_STATE__.lastMessageTime < 1000) {
                return false;
            }

            const messageKey = `${type}-${JSON.stringify(data)}-${now}`;
            if (window.__WIDGET_STATE__.processedMessages.has(messageKey)) {
                return false;
            }

            window.__WIDGET_STATE__.lastMessageTime = now;
            window.__WIDGET_STATE__.processedMessages.add(messageKey);

            // Clean up old messages
            if (window.__WIDGET_STATE__.processedMessages.size > 100) {
                const oldestMessage = Array.from(window.__WIDGET_STATE__.processedMessages)[0];
                window.__WIDGET_STATE__.processedMessages.delete(oldestMessage);
            }

            return true;
        }

        // Enhanced resource tracking
        const resourceObserver = new PerformanceObserver((list) => {
            list.getEntries().forEach(entry => {
                const resource = entry.name;
                const type = entry.initiatorType;
                const duration = entry.duration;
                
                if (shouldProcessMessage('RESOURCE', { resource, type })) {
                    logState('RESOURCE', `Loaded ${type}: ${resource}`, {
                        duration,
                        size: entry.transferSize
                    });
                }

                window.__WIDGET_STATE__.resources[type + 's']?.add(resource);
                window.__WIDGET_STATE__.resources.loadedCount++;
                
                checkResourcesComplete();
            });
        });

        resourceObserver.observe({ entryTypes: ['resource'] });

        function checkResourcesComplete() {
            const state = window.__WIDGET_STATE__;
            if (state.resources.loadedCount === state.resources.totalCount) {
                logState('COMPLETE', 'All resources loaded', {
                    count: state.resources.loadedCount,
                    timing: Date.now() - state.loadStartTime
                });
            }
        }

        function logState(type, message, data = {}) {
            if (!shouldProcessMessage(type, { message, ...data })) {
                return;
            }

            const log = {
                type,
                message,
                timestamp: Date.now(),
                timeSinceStart: Date.now() - window.__WIDGET_STATE__.loadStartTime,
                state: { ...window.__WIDGET_STATE__ },
                data
            };
            window.__WIDGET_STATE__.logs.push(log);
            console.log(`[Widget ${type}]`, message, data);
            
            window.parent.postMessage({
                type: 'WIDGET_STATE',
                state: window.__WIDGET_STATE__,
                log
            }, '*');
        }

        // Enhanced error tracking with resource failures
        window.onerror = function(msg, url, line, col, error) {
            window.__WIDGET_STATE__.error = {
                message: msg,
                url,
                line,
                stack: error?.stack
            };
            logState('ERROR', msg, { url, line, col, stack: error?.stack });
            return false;
        };

        // Track React availability with enhanced validation
        Object.defineProperty(window, 'React', {
            set: function(value) {
                window.__WIDGET_STATE__.reactLoaded = true;
                logState('REACT', 'React loaded and available', {
                    version: value?.version
                });
                return value;
            },
            configurable: true
        });

        // Initialize widget with enhanced resource tracking
        window.__initializeWidget = function(sweepstakesId) {
            logState('INIT', 'Initializing widget', { sweepstakesId });
            
            try {
                if (!window.initializeWidget) {
                    throw new Error('Widget initialization function not found');
                }
                
                window.initializeWidget(sweepstakesId);
                window.__WIDGET_STATE__.widgetInitialized = true;
                logState('SUCCESS', 'Widget initialized successfully');
                
                window.parent.postMessage({ 
                    type: 'WIDGET_READY',
                    sweepstakesId 
                }, '*');
            } catch (error) {
                logState('ERROR', 'Initialization failed', {
                    message: error.message,
                    stack: error.stack
                });
                
                window.parent.postMessage({ 
                    type: 'WIDGET_ERROR',
                    error: {
                        message: 'Initialization failed',
                        details: error.message,
                        stack: error.stack
                    }
                }, '*');
                throw error;
            }
        };

        // Load widget bundle with enhanced tracking
        const scriptLoadTimeout = setTimeout(() => {
            if (!window.__WIDGET_STATE__.reactLoaded) {
                logState('TIMEOUT', 'Script load timeout');
            }
        }, 5000);

        // Enhanced script loading with validation
        const widgetScript = document.createElement('script');
        widgetScript.src = 'widget-bundle.js';
        widgetScript.onload = () => {
            clearTimeout(scriptLoadTimeout);
            logState('LOAD', 'Widget bundle loaded successfully');
            validateResources();
        };
        widgetScript.onerror = (error) => {
            clearTimeout(scriptLoadTimeout);
            logState('ERROR', 'Failed to load widget bundle', { error });
        };

        // Validate all required resources
        function validateResources() {
            const requiredResources = ['widget-bundle.js', 'React', 'ReactDOM'];
            const missingResources = requiredResources.filter(resource => {
                if (resource === 'React') return !window.React;
                if (resource === 'ReactDOM') return !window.ReactDOM;
                return !window.__WIDGET_STATE__.resources.scripts.has(resource);
            });

            if (missingResources.length > 0) {
                logState('ERROR', 'Missing required resources', { missingResources });
            } else {
                logState('VALIDATION', 'All required resources loaded');
            }
        }

        document.body.appendChild(widgetScript);
    </script>
</body>
</html>