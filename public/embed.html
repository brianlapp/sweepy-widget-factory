<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweepstakes Widget</title>
    <script>
        // Enhanced diagnostic logging utility
        const logger = {
            timeStart: Date.now(),
            errors: [],
            metrics: {
                resourceLoadTimes: {},
                renderingSteps: [],
                reactInitTime: null,
                messageEvents: []
            },
            info: function(msg, ...args) {
                console.log(`[Widget Embed] ${msg}`, ...args);
                this.sendToParent('DEBUG_LOG', msg);
            },
            error: function(msg, ...args) {
                console.error(`[Widget Embed] Error: ${msg}`, ...args);
                this.sendToParent('WIDGET_ERROR', { message: msg, details: args });
            },
            sendToParent: function(type, message) {
                if (window.parent) {
                    window.parent.postMessage({ type, message, timestamp: Date.now() }, '*');
                }
            }
        };

        // Early error capture with detailed logging
        window.onerror = function(msg, url, line, col, error) {
            logger.error('Global error:', { msg, url, line, col, error: error?.stack });
            return false;
        };

        window.addEventListener('unhandledrejection', function(event) {
            logger.error('Unhandled promise rejection:', event.reason);
        });

        // Track all message events
        window.addEventListener('message', function(event) {
            logger.metrics.messageEvents.push({
                type: event.data.type,
                timestamp: Date.now(),
                data: event.data
            });
            
            logger.info('Message received:', event.data);
        });

        // Resource loading diagnostics
        const resourcePerf = {
            start: Date.now(),
            end: function() {
                logger.info('Resource loading completed in:', Date.now() - this.start, 'ms');
            }
        };

        window.addEventListener('load', () => {
            resourcePerf.end();
            logger.info('Window loaded, checking dependencies:', {
                react: typeof React !== 'undefined',
                reactDOM: typeof ReactDOM !== 'undefined'
            });
        });
    </script>
    <script 
        crossorigin 
        src="https://unpkg.com/react@18/umd/react.production.min.js"
        onload="logger.info('React core loaded')"
        onerror="logger.error('Failed to load React')"
    ></script>
    <script 
        crossorigin 
        src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
        onload="logger.info('ReactDOM loaded')"
        onerror="logger.error('Failed to load ReactDOM')"
    ></script>
</head>
<body>
    <div id="root"></div>
    <script>
        // Enhanced initialization with better error handling
        let initRetries = 0;
        const MAX_RETRIES = 3;
        const RETRY_DELAY = 1000;
        
        function validateSweepstakesId(id) {
            if (!id) {
                throw new Error('No sweepstakes ID provided');
            }
            // Validate UUID format
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
            if (!uuidRegex.test(id)) {
                throw new Error('Invalid sweepstakes ID format');
            }
            return true;
        }

        // Handle initialization message
        window.addEventListener('message', function(event) {
            try {
                logger.info('Received message:', event.data);
                
                if (event.data.type === 'INIT_WIDGET') {
                    if (!event.data.sweepstakesId) {
                        throw new Error('No sweepstakes ID provided in init message');
                    }

                    validateSweepstakesId(event.data.sweepstakesId);
                    logger.info('Valid sweepstakes ID received:', event.data.sweepstakesId);
                    
                    window.WIDGET_CONFIG = event.data;
                    initializeWidgetWithRetry(event.data);
                }
            } catch (error) {
                logger.error('Message handling error:', error);
                showFallbackContent(error);
            }
        });

        // Notify parent when ready
        setTimeout(() => {
            if (window.parent) {
                window.parent.postMessage({ type: 'WIDGET_READY', timestamp: Date.now() }, '*');
            }
        }, 1000);

        logger.info('Embed page ready');
    </script>
</body>
</html>