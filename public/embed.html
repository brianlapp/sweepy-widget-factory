<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweepstakes Widget</title>
    <script>
        // Enhanced diagnostic logging utility
        const logger = {
            timeStart: Date.now(),
            errors: [],
            metrics: {
                resourceLoadTimes: {},
                renderingSteps: [],
                reactInitTime: null,
                messageEvents: []
            },
            info: function(msg, ...args) {
                const timestamp = new Date().toISOString();
                console.log(`[Widget Embed ${timestamp}] ${msg}`, ...args);
                this.sendToParent('DEBUG_LOG', { message: msg, args, timestamp });
            },
            error: function(msg, ...args) {
                const timestamp = new Date().toISOString();
                const error = args[0] instanceof Error ? args[0] : new Error(msg);
                console.error(`[Widget Embed ${timestamp}] Error: ${msg}`, ...args);
                
                const errorDetails = {
                    message: msg,
                    stack: error.stack,
                    args: args.map(arg => 
                        arg instanceof Error ? 
                            { message: arg.message, stack: arg.stack } : 
                            arg
                    ),
                    timestamp
                };
                
                this.errors.push(errorDetails);
                this.sendToParent('WIDGET_ERROR', errorDetails);
            },
            sendToParent: function(type, message) {
                try {
                    if (window.parent) {
                        const event = { 
                            type, 
                            message, 
                            timestamp: Date.now(),
                            timeSinceStart: Date.now() - this.timeStart
                        };
                        window.parent.postMessage(event, '*');
                        this.metrics.messageEvents.push(event);
                    }
                } catch (error) {
                    console.error('[Widget Embed] Error sending message to parent:', error);
                }
            },
            trackResourceLoad: function(resource) {
                this.metrics.resourceLoadTimes[resource] = {
                    loadTime: Date.now() - this.timeStart,
                    status: 'loaded'
                };
                this.info(`Resource loaded: ${resource}`);
            },
            trackReactInit: function() {
                this.metrics.reactInitTime = Date.now() - this.timeStart;
                this.info('React initialization time:', this.metrics.reactInitTime);
            }
        };

        // Early error capture
        window.onerror = function(msg, url, line, col, error) {
            logger.error('Global error:', { msg, url, line, col, error: error?.stack });
            return false;
        };

        window.addEventListener('unhandledrejection', function(event) {
            logger.error('Unhandled promise rejection:', event.reason);
        });

        // Track React initialization
        let reactInitialized = false;
        let reactDOMInitialized = false;

        function checkReactInitialization() {
            if (typeof React !== 'undefined' && typeof ReactDOM !== 'undefined') {
                if (!reactInitialized || !reactDOMInitialized) {
                    logger.info('React and ReactDOM successfully initialized');
                    logger.trackReactInit();
                    reactInitialized = true;
                    reactDOMInitialized = true;
                }
            } else {
                logger.error('React initialization check failed', {
                    react: typeof React !== 'undefined',
                    reactDOM: typeof ReactDOM !== 'undefined'
                });
            }
        }

        // Track all message events
        window.addEventListener('message', function(event) {
            logger.info('Message received:', event.data);
            logger.metrics.messageEvents.push({
                type: event.data.type,
                timestamp: Date.now(),
                data: event.data
            });

            if (event.data.type === 'INIT_WIDGET') {
                logger.info('Initializing widget with config:', event.data);
                window.WIDGET_CONFIG = event.data;
                initializeWidgetWithRetry(event.data);
            }
        });

        // Resource loading diagnostics
        const resourcePerf = {
            start: Date.now(),
            resources: new Set(),
            trackResource: function(url) {
                this.resources.add(url);
                logger.info('Resource requested:', url);
            },
            end: function() {
                const loadTime = Date.now() - this.start;
                logger.info('Resource loading completed in:', loadTime, 'ms');
                logger.info('Loaded resources:', Array.from(this.resources));
            }
        };

        // Enhanced script loading with error handling
        function loadScript(src, onload, onerror) {
            const script = document.createElement('script');
            script.src = src;
            script.crossOrigin = 'anonymous';
            script.onload = () => {
                logger.info(`Script loaded: ${src}`);
                checkReactInitialization();
                onload?.();
            };
            script.onerror = (error) => {
                logger.error(`Script load error: ${src}`, error);
                onerror?.(error);
            };
            document.head.appendChild(script);
            resourcePerf.trackResource(src);
        }

        // Load React with retries
        function loadReactScripts(retryCount = 0) {
            const maxRetries = 3;
            const retryDelay = 1000;

            loadScript(
                'https://unpkg.com/react@18/umd/react.production.min.js',
                () => {
                    loadScript(
                        'https://unpkg.com/react-dom@18/umd/react-dom.production.min.js',
                        () => {
                            logger.info('All React scripts loaded successfully');
                            checkReactInitialization();
                        },
                        (error) => {
                            logger.error('Failed to load ReactDOM:', error);
                            if (retryCount < maxRetries) {
                                setTimeout(() => loadReactScripts(retryCount + 1), retryDelay);
                            }
                        }
                    );
                },
                (error) => {
                    logger.error('Failed to load React:', error);
                    if (retryCount < maxRetries) {
                        setTimeout(() => loadReactScripts(retryCount + 1), retryDelay);
                    }
                }
            );
        }

        // Start loading React scripts
        loadReactScripts();
    </script>
</head>
<body>
    <div id="root"></div>
    <script>
        let initRetries = 0;
        const MAX_RETRIES = 3;
        const RETRY_DELAY = 1000;

        function initializeWidgetWithRetry(config) {
            try {
                logger.info('Starting widget initialization');
                
                if (!reactInitialized || !reactDOMInitialized) {
                    throw new Error('React not fully initialized');
                }

                if (typeof window.initializeWidget !== 'function') {
                    throw new Error('Widget initialization function not found');
                }

                window.initializeWidget(config.sweepstakesId);
                logger.info('Widget initialized successfully');
                
                logger.sendToParent('WIDGET_READY', {
                    timestamp: Date.now(),
                    metrics: logger.metrics
                });
            } catch (error) {
                logger.error('Widget initialization failed:', error);
                
                if (initRetries < MAX_RETRIES) {
                    initRetries++;
                    logger.info(`Retrying initialization (${initRetries}/${MAX_RETRIES})`);
                    setTimeout(() => initializeWidgetWithRetry(config), RETRY_DELAY * initRetries);
                } else {
                    logger.error('Max initialization retries reached');
                    showFallbackContent(error);
                }
            }
        }

        function showFallbackContent(error) {
            const root = document.getElementById('root');
            if (root) {
                root.innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <p style="color: #666;">Widget initialization failed</p>
                        <pre style="font-size: 12px; margin-top: 10px; text-align: left; background: #f5f5f5; padding: 10px; border-radius: 4px; overflow: auto;">
                            ${error.stack || error.message}
                        </pre>
                    </div>
                `;
            }
        }

        // Log when the page is fully loaded
        window.addEventListener('load', () => {
            resourcePerf.end();
            checkReactInitialization();
            logger.info('Window loaded, checking dependencies:', {
                react: reactInitialized,
                reactDOM: reactDOMInitialized
            });
        });

        logger.info('Embed page ready');
    </script>
</body>
</html>