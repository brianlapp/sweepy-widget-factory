<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweepstakes Widget</title>
    <script>
        // Enhanced diagnostic logging utility
        const logger = {
            timeStart: Date.now(),
            errors: [],
            metrics: {
                resourceLoadTimes: {},
                renderingSteps: [],
                reactInitTime: null,
                messageEvents: []
            },
            info: function(msg, ...args) {
                const timestamp = new Date().toISOString();
                console.log(`[Widget Embed ${timestamp}] ${msg}`, ...args);
                this.sendToParent('DEBUG_LOG', { message: msg, args, timestamp });
            },
            error: function(msg, ...args) {
                const timestamp = new Date().toISOString();
                const error = args[0] instanceof Error ? args[0] : new Error(msg);
                console.error(`[Widget Embed ${timestamp}] Error: ${msg}`, ...args);
                
                const errorDetails = {
                    message: msg,
                    stack: error.stack,
                    args: args.map(arg => 
                        arg instanceof Error ? 
                            { message: arg.message, stack: arg.stack } : 
                            arg
                    ),
                    timestamp
                };
                
                this.errors.push(errorDetails);
                this.sendToParent('WIDGET_ERROR', errorDetails);
            },
            sendToParent: function(type, message) {
                if (window.parent) {
                    const event = { 
                        type, 
                        message, 
                        timestamp: Date.now(),
                        timeSinceStart: Date.now() - this.timeStart
                    };
                    window.parent.postMessage(event, '*');
                    this.metrics.messageEvents.push(event);
                }
            },
            trackResourceLoad: function(resource) {
                this.metrics.resourceLoadTimes[resource] = {
                    loadTime: Date.now() - this.timeStart,
                    status: 'loaded'
                };
                this.info(`Resource loaded: ${resource}`);
            }
        };

        // Early error capture
        window.onerror = function(msg, url, line, col, error) {
            logger.error('Global error:', { msg, url, line, col, error: error?.stack });
            return false;
        };

        window.addEventListener('unhandledrejection', function(event) {
            logger.error('Unhandled promise rejection:', event.reason);
        });

        // Track all message events
        window.addEventListener('message', function(event) {
            logger.metrics.messageEvents.push({
                type: event.data.type,
                timestamp: Date.now(),
                data: event.data
            });
            
            logger.info('Message received:', event.data);
        });

        // Resource loading diagnostics
        const resourcePerf = {
            start: Date.now(),
            resources: new Set(),
            trackResource: function(url) {
                this.resources.add(url);
                logger.info('Resource requested:', url);
            },
            end: function() {
                const loadTime = Date.now() - this.start;
                logger.info('Resource loading completed in:', loadTime, 'ms');
                logger.info('Loaded resources:', Array.from(this.resources));
            }
        };

        window.addEventListener('load', () => {
            resourcePerf.end();
            logger.info('Window loaded, checking dependencies:', {
                react: typeof React !== 'undefined',
                reactDOM: typeof ReactDOM !== 'undefined'
            });
        });
    </script>
    <script 
        crossorigin 
        src="https://unpkg.com/react@18/umd/react.production.min.js"
        onload="logger.trackResourceLoad('react')"
        onerror="logger.error('Failed to load React')"
    ></script>
    <script 
        crossorigin 
        src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
        onload="logger.trackResourceLoad('react-dom')"
        onerror="logger.error('Failed to load ReactDOM')"
    ></script>
</head>
<body>
    <div id="root"></div>
    <script>
        // Enhanced initialization with better error handling
        let initRetries = 0;
        const MAX_RETRIES = 3;
        const RETRY_DELAY = 1000;
        
        function validateSweepstakesId(id) {
            if (!id) {
                throw new Error('No sweepstakes ID provided');
            }
            // Validate UUID format
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
            if (!uuidRegex.test(id)) {
                throw new Error('Invalid sweepstakes ID format');
            }
            return true;
        }

        function initializeWidgetWithRetry(config) {
            try {
                logger.info('Initializing widget with config:', config);
                
                if (typeof window.initializeWidget !== 'function') {
                    throw new Error('Widget initialization function not found');
                }

                window.initializeWidget(config.sweepstakesId);
                logger.info('Widget initialized successfully');
            } catch (error) {
                logger.error('Widget initialization failed:', error);
                
                if (initRetries < MAX_RETRIES) {
                    initRetries++;
                    logger.info(`Retrying initialization (${initRetries}/${MAX_RETRIES})`);
                    setTimeout(() => initializeWidgetWithRetry(config), RETRY_DELAY * initRetries);
                } else {
                    logger.error('Max initialization retries reached');
                    showFallbackContent(error);
                }
            }
        }

        function showFallbackContent(error) {
            const root = document.getElementById('root');
            if (root) {
                root.innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <p style="color: #666;">Widget initialization failed</p>
                        <pre style="font-size: 12px; margin-top: 10px; text-align: left; background: #f5f5f5; padding: 10px; border-radius: 4px; overflow: auto;">
                            ${error.stack || error.message}
                        </pre>
                    </div>
                `;
            }
        }

        // Handle initialization message
        window.addEventListener('message', function(event) {
            try {
                logger.info('Received message:', event.data);
                
                if (event.data.type === 'INIT_WIDGET') {
                    if (!event.data.sweepstakesId) {
                        throw new Error('No sweepstakes ID provided in init message');
                    }

                    validateSweepstakesId(event.data.sweepstakesId);
                    logger.info('Valid sweepstakes ID received:', event.data.sweepstakesId);
                    
                    window.WIDGET_CONFIG = event.data;
                    initializeWidgetWithRetry(event.data);
                }
            } catch (error) {
                logger.error('Message handling error:', error);
                showFallbackContent(error);
            }
        });

        // Notify parent when ready
        setTimeout(() => {
            if (window.parent) {
                window.parent.postMessage({ 
                    type: 'WIDGET_READY', 
                    timestamp: Date.now(),
                    metrics: logger.metrics
                }, '*');
            }
        }, 1000);

        logger.info('Embed page ready');
    </script>
</body>
</html>