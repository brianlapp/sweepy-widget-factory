<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweepstakes Widget</title>
    <script>
        // Enhanced diagnostic logging utility
        const logger = {
            timeStart: Date.now(),
            errors: [],
            metrics: {
                resourceLoadTimes: {},
                renderingSteps: [],
                reactInitTime: null,
                messageEvents: [],
                reactStatus: null
            },
            info: function(msg, ...args) {
                const timestamp = new Date().toISOString();
                console.log(`[Widget Embed ${timestamp}] ${msg}`, ...args);
                this.sendToParent('DEBUG_LOG', { message: msg, args, timestamp });
            },
            error: function(msg, ...args) {
                const timestamp = new Date().toISOString();
                const error = args[0] instanceof Error ? args[0] : new Error(msg);
                console.error(`[Widget Embed ${timestamp}] Error: ${msg}`, ...args);
                
                const errorDetails = {
                    message: msg,
                    stack: error.stack,
                    args: args.map(arg => 
                        arg instanceof Error ? 
                            { message: arg.message, stack: arg.stack } : 
                            arg
                    ),
                    timestamp
                };
                
                this.errors.push(errorDetails);
                this.sendToParent('WIDGET_ERROR', errorDetails);
            },
            sendToParent: function(type, message) {
                try {
                    if (window.parent) {
                        const event = { 
                            type, 
                            message, 
                            timestamp: Date.now(),
                            timeSinceStart: Date.now() - this.timeStart,
                            reactStatus: this.metrics.reactStatus
                        };
                        window.parent.postMessage(event, '*');
                        this.metrics.messageEvents.push(event);
                    }
                } catch (error) {
                    console.error('[Widget Embed] Error sending message to parent:', error);
                }
            },
            checkReactStatus: function() {
                this.metrics.reactStatus = {
                    react: typeof React !== 'undefined' ? 'loaded' : 'missing',
                    reactDOM: typeof ReactDOM !== 'undefined' ? 'loaded' : 'missing',
                    root: document.getElementById('root') ? 'found' : 'missing',
                    initTime: this.metrics.reactInitTime
                };
                return this.metrics.reactStatus;
            }
        };

        // Early error capture
        window.onerror = function(msg, url, line, col, error) {
            logger.error('Global error:', { msg, url, line, col, error: error?.stack });
            return false;
        };

        window.addEventListener('unhandledrejection', function(event) {
            logger.error('Unhandled promise rejection:', event.reason);
        });

        // Enhanced message event listener with detailed logging
        window.addEventListener('message', function(event) {
            logger.info('Message received:', event.data);
            
            if (event.data.type === 'INIT_WIDGET') {
                const reactStatus = logger.checkReactStatus();
                logger.info('React initialization status:', reactStatus);
                
                if (reactStatus.react === 'missing' || reactStatus.reactDOM === 'missing') {
                    logger.error('React not properly initialized', reactStatus);
                    return;
                }
                
                if (!reactStatus.root) {
                    logger.error('Root element not found');
                    return;
                }

                logger.info('Initializing widget with config:', event.data);
                window.WIDGET_CONFIG = event.data;
                initializeWidgetWithRetry(event.data);
            }
        });

        // Enhanced script loading with verification
        function loadScript(src, onload, onerror) {
            logger.info(`Loading script: ${src}`);
            const script = document.createElement('script');
            script.src = src;
            script.crossOrigin = 'anonymous';
            script.onload = () => {
                logger.info(`Script loaded successfully: ${src}`);
                const reactStatus = logger.checkReactStatus();
                logger.info('React status after script load:', reactStatus);
                onload?.();
            };
            script.onerror = (error) => {
                logger.error(`Script load error: ${src}`, error);
                onerror?.(error);
            };
            document.head.appendChild(script);
        }

        // Load React with enhanced verification
        function loadReactScripts(retryCount = 0) {
            const maxRetries = 3;
            const retryDelay = 1000;

            loadScript(
                'https://unpkg.com/react@18/umd/react.production.min.js',
                () => {
                    logger.info('React core loaded, loading ReactDOM...');
                    loadScript(
                        'https://unpkg.com/react-dom@18/umd/react-dom.production.min.js',
                        () => {
                            logger.info('All React scripts loaded successfully');
                            const status = logger.checkReactStatus();
                            logger.sendToParent('REACT_LOADED', status);
                        },
                        (error) => {
                            logger.error('Failed to load ReactDOM:', error);
                            if (retryCount < maxRetries) {
                                setTimeout(() => loadReactScripts(retryCount + 1), retryDelay);
                            }
                        }
                    );
                },
                (error) => {
                    logger.error('Failed to load React:', error);
                    if (retryCount < maxRetries) {
                        setTimeout(() => loadReactScripts(retryCount + 1), retryDelay);
                    }
                }
            );
        }

        // Start loading React scripts
        loadReactScripts();
    </script>
</head>
<body>
    <div id="root"></div>
    <script>
        let initRetries = 0;
        const MAX_RETRIES = 3;
        const RETRY_DELAY = 1000;

        function initializeWidgetWithRetry(config) {
            try {
                logger.info('Starting widget initialization');
                
                if (!reactInitialized || !reactDOMInitialized) {
                    throw new Error('React not fully initialized');
                }

                if (typeof window.initializeWidget !== 'function') {
                    throw new Error('Widget initialization function not found');
                }

                window.initializeWidget(config.sweepstakesId);
                logger.info('Widget initialized successfully');
                
                logger.sendToParent('WIDGET_READY', {
                    timestamp: Date.now(),
                    metrics: logger.metrics
                });
            } catch (error) {
                logger.error('Widget initialization failed:', error);
                
                if (initRetries < MAX_RETRIES) {
                    initRetries++;
                    logger.info(`Retrying initialization (${initRetries}/${MAX_RETRIES})`);
                    setTimeout(() => initializeWidgetWithRetry(config), RETRY_DELAY * initRetries);
                } else {
                    logger.error('Max initialization retries reached');
                    showFallbackContent(error);
                }
            }
        }

        function showFallbackContent(error) {
            const root = document.getElementById('root');
            if (root) {
                root.innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <p style="color: #666;">Widget initialization failed</p>
                        <pre style="font-size: 12px; margin-top: 10px; text-align: left; background: #f5f5f5; padding: 10px; border-radius: 4px; overflow: auto;">
                            ${error.stack || error.message}
                        </pre>
                    </div>
                `;
            }
        }

        // Log when the page is fully loaded
        window.addEventListener('load', () => {
            resourcePerf.end();
            checkReactInitialization();
            logger.info('Window loaded, checking dependencies:', {
                react: reactInitialized,
                reactDOM: reactDOMInitialized
            });
        });

        logger.info('Embed page ready');
    </script>
</body>
</html>
