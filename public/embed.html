<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweepstakes Widget</title>
    <!-- Load React synchronously -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script>
        // Enhanced diagnostic logging utility
        const logger = {
            timeStart: Date.now(),
            info: function(msg, ...args) {
                const timestamp = new Date().toISOString();
                console.log(`[Widget Embed ${timestamp}] ${msg}`, ...args);
                this.sendToParent('DEBUG_LOG', { message: msg, args, timestamp });
            },
            error: function(msg, ...args) {
                const timestamp = new Date().toISOString();
                console.error(`[Widget Embed ${timestamp}] Error: ${msg}`, ...args);
                this.sendToParent('WIDGET_ERROR', { message: msg, args, timestamp });
            },
            sendToParent: function(type, message) {
                try {
                    if (window.parent) {
                        window.parent.postMessage({ 
                            type, 
                            message,
                            timestamp: Date.now(),
                            timeSinceStart: Date.now() - this.timeStart,
                            reactStatus: this.verifyReact()
                        }, '*');
                    }
                } catch (error) {
                    console.error('[Widget Embed] Error sending message to parent:', error);
                }
            },
            verifyReact: function() {
                return {
                    react: typeof React !== 'undefined',
                    reactDOM: typeof ReactDOM !== 'undefined',
                    version: React?.version
                };
            }
        };

        // Verify React loaded successfully
        window.addEventListener('load', function() {
            const reactStatus = logger.verifyReact();
            if (!reactStatus.react || !reactStatus.reactDOM) {
                logger.error('React failed to load', reactStatus);
                return;
            }
            logger.info('React loaded successfully', reactStatus);
        });

        // Handle widget initialization
        window.addEventListener('message', function(event) {
            if (event.data.type === 'INIT_WIDGET') {
                const reactStatus = logger.verifyReact();
                if (!reactStatus.react || !reactStatus.reactDOM) {
                    logger.error('React not available for widget initialization');
                    return;
                }

                logger.info('Initializing widget with config:', event.data);
                window.WIDGET_CONFIG = event.data;
                
                try {
                    window.initializeWidget(event.data.sweepstakesId);
                    logger.info('Widget initialized successfully');
                    logger.sendToParent('WIDGET_READY', { timestamp: Date.now() });
                } catch (error) {
                    logger.error('Widget initialization failed:', error);
                }
            }
        });

        // Global error handlers
        window.onerror = function(msg, url, line, col, error) {
            logger.error('Global error:', { msg, url, line, col, error: error?.stack });
            return false;
        };

        window.addEventListener('unhandledrejection', function(event) {
            logger.error('Unhandled promise rejection:', event.reason);
        });
    </script>
</head>
<body>
    <div id="root"></div>
</body>
</html>