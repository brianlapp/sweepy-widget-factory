<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweepstakes Widget</title>
    <script>
        // Enhanced diagnostic logging utility with verbose error tracking and performance metrics
        const logger = {
            timeStart: Date.now(),
            errors: [],
            metrics: {
                resourceLoadTimes: {},
                renderingSteps: [],
                reactInitTime: null
            },
            formatTime: () => `[${new Date().toISOString()}]`,
            info: function(msg, ...args) {
                console.log(`${this.formatTime()} [Widget Embed] ${msg}`, ...args);
                this.metrics.renderingSteps.push({
                    type: 'info',
                    message: msg,
                    timestamp: Date.now() - this.timeStart
                });
            },
            error: function(msg, ...args) {
                const error = { 
                    message: msg, 
                    details: args, 
                    timestamp: new Date().toISOString(),
                    stack: args[0]?.stack
                };
                this.errors.push(error);
                console.error(`${this.formatTime()} [Widget Embed] Error: ${msg}`, ...args);
                
                // Send detailed error to parent
                if (window.parent) {
                    window.parent.postMessage({ 
                        type: 'WIDGET_ERROR', 
                        error,
                        errorCount: this.errors.length,
                        metrics: this.metrics
                    }, '*');
                }
            },
            warn: function(msg, ...args) {
                console.warn(`${this.formatTime()} [Widget Embed] Warning: ${msg}`, ...args);
            },
            performance: function(label) {
                const start = performance.now();
                return {
                    end: () => {
                        const duration = performance.now() - start;
                        this.metrics.resourceLoadTimes[label] = duration;
                        this.info(`${label} took ${duration.toFixed(2)}ms`);
                    }
                };
            },
            getErrorSummary: function() {
                return this.errors.map(e => `${e.timestamp}: ${e.message}`).join('\n');
            },
            getDiagnosticReport: function() {
                return {
                    errors: this.errors,
                    metrics: this.metrics,
                    environment: {
                        userAgent: navigator.userAgent,
                        reactVersion: window.React?.version,
                        reactDomVersion: window.ReactDOM?.version,
                        timestamp: new Date().toISOString()
                    }
                };
            }
        };

        // Early error capture
        window.onerror = function(msg, url, line, col, error) {
            logger.error('Global error:', { msg, url, line, col, error });
            return false;
        };

        window.addEventListener('unhandledrejection', function(event) {
            logger.error('Unhandled promise rejection:', event.reason);
        });

        // Resource loading diagnostics
        const resourcePerf = logger.performance('resource-loading');
        window.addEventListener('load', () => {
            resourcePerf.end();
            logger.info('Window loaded, checking dependencies:', {
                react: typeof React !== 'undefined',
                reactDOM: typeof ReactDOM !== 'undefined'
            });
        });

        logger.info('Embed page initializing...');
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js" 
            onerror="logger.error('Failed to load React')"
            onload="logger.info('React core loaded successfully')"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
            onerror="logger.error('Failed to load ReactDOM')"
            onload="logger.info('ReactDOM loaded successfully')"></script>
</head>
<body>
    <div id="root"></div>
    <script>
        // Enhanced initialization with better error handling and retries
        let initRetries = 0;
        const MAX_RETRIES = 3;
        const RETRY_DELAY = 1000;
        const SCRIPT_TIMEOUT = 5000;
        
        function loadWidgetScript() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'widget.js';
                script.async = true;

                const timeoutId = setTimeout(() => {
                    reject(new Error('Widget script load timeout'));
                }, SCRIPT_TIMEOUT);

                script.onload = () => {
                    clearTimeout(timeoutId);
                    logger.info('Widget script loaded successfully');
                    resolve();
                };

                script.onerror = (error) => {
                    clearTimeout(timeoutId);
                    reject(new Error('Failed to load widget script: ' + error.message));
                };

                document.body.appendChild(script);
            });
        }

        // Diagnostic component for verifying React setup
        function renderDiagnosticComponent() {
            try {
                const DiagnosticComponent = () => {
                    React.useEffect(() => {
                        logger.info('Diagnostic component mounted');
                    }, []);

                    return React.createElement('div', {
                        style: {
                            padding: '20px',
                            border: '1px solid #eee',
                            borderRadius: '8px',
                            margin: '20px',
                            backgroundColor: '#f9f9f9'
                        }
                    }, 'Widget Environment: Ready');
                };

                const root = ReactDOM.createRoot(document.getElementById('root'));
                root.render(React.createElement(DiagnosticComponent));
                logger.info('Diagnostic component rendered successfully');
            } catch (error) {
                logger.error('Failed to render diagnostic component:', error);
                showFallbackContent(error);
            }
        }
        
        async function initializeWidgetWithRetry(data) {
            try {
                if (!window.initializeWidget) {
                    if (initRetries < MAX_RETRIES) {
                        initRetries++;
                        logger.warn(`Retry ${initRetries}/${MAX_RETRIES} - Widget not ready, attempting to load script`);
                        await loadWidgetScript();
                        setTimeout(() => initializeWidgetWithRetry(data), RETRY_DELAY);
                    } else {
                        throw new Error('Widget initialization failed after retries');
                    }
                } else {
                    logger.info('Initializing widget with data:', data);
                    window.initializeWidget(data.sweepstakesId);
                    logger.info('Widget initialized successfully');
                }
            } catch (error) {
                logger.error('Initialization error:', error);
                showFallbackContent(error);
            }
        }

        function showFallbackContent(error) {
            const root = document.getElementById('root');
            if (root) {
                root.innerHTML = `
                    <div style="padding: 20px; border: 1px solid #f0f0f0; border-radius: 8px; text-align: center;">
                        <p style="color: #666; margin: 0;">Unable to load sweepstakes widget</p>
                        <p style="color: #888; font-size: 0.8em; margin-top: 8px;">${error.message}</p>
                        <details style="margin-top: 16px; text-align: left;">
                            <summary style="cursor: pointer; color: #666;">Technical Details</summary>
                            <pre style="background: #f5f5f5; padding: 8px; margin-top: 8px; font-size: 0.8em; overflow-x: auto;">
${logger.getErrorSummary()}
                            </pre>
                        </details>
                        <div style="margin-top: 16px;">
                            <button onclick="location.reload()" 
                                    style="padding: 8px 16px; background: #4f46e5; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Retry Loading
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Enhanced message handling with error tracking
        window.addEventListener('message', function(event) {
            try {
                logger.info('Received message:', event.data);
                
                if (event.data.type === 'INIT_WIDGET') {
                    if (!event.data.sweepstakesId) {
                        throw new Error('No sweepstakes ID provided');
                    }
                    window.WIDGET_CONFIG = event.data;
                    initializeWidgetWithRetry(event.data);
                }
            } catch (error) {
                logger.error('Message handling error:', error);
                showFallbackContent(error);
            }
        });

        // Initial diagnostic render to verify React setup
        setTimeout(() => {
            if (!window.initializeWidget) {
                renderDiagnosticComponent();
            }
        }, 1000);

        logger.info('Embed page ready');
    </script>
</body>
</html>